<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Шашки</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    .header {
      width: 100%;
      padding: 10px;
      background-color: #333;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .room-list {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px;
    }
    .room {
      padding: 10px;
      background-color: #007bff;
      color: white;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      min-width: 80px;
    }
    .room.full {
      background-color: #dc3545;
      cursor: not-allowed;
    }
    .game-container {
      display: flex;
      margin-top: 20px;
      gap: 20px;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(8, 80px);
      grid-template-rows: repeat(8, 80px);
      border: 2px solid #333;
    }
    .cell {
      width: 80px;
      height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .cell:nth-child(odd):nth-child(even),
    .cell:nth-child(even):nth-child(odd) {
      background-color: #769656;
    }
    .cell:nth-child(odd):nth-child(odd),
    .cell:nth-child(even):nth-child(even) {
      background-color: #eeeed2;
    }
    .piece {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      cursor: grab;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
    }
    .piece.black {
      background-color: black;
    }
    .piece.white {
      background-color: white;
    }
    .piece.king::after {
      content: "♛";
      font-size: 36px;
    }
    .chat {
      width: 300px;
      display: flex;
      flex-direction: column;
      border: 2px solid #333;
      border-radius: 8px;
      background-color: white;
      overflow: hidden;
    }
    .chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background-color: #f9f9f9;
      max-height: 500px;
    }
    .chat-input {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
      background-color: #fff;
    }
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .chat-input button {
      margin-left: 10px;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Шашки</h1>
    <div class="room-list" id="roomList"></div>
  </div>
  <div class="game-container">
    <div class="board" id="board"></div>
    <div class="chat">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Введите сообщение">
        <button id="chatSend">Отправить</button>
      </div>
    </div>
  </div>

  <script>
    const roomList = document.getElementById("roomList");
    const board = document.getElementById("board");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");

    const channel = new BroadcastChannel("checkers_game");
    const rooms = Array.from({ length: 10 }, (_, i) => ({ id: i, players: [], boardState: null, chat: [] }));
    let currentRoom = null;
    let playerColor = null;
    let boardState = Array(8).fill(null).map(() => Array(8).fill(null));
    let turn = "white";

    function initializeRooms() {
      rooms.forEach(room => {
        const roomDiv = document.createElement("div");
        roomDiv.classList.add("room");
        roomDiv.textContent = `Комната ${room.id + 1}`;
        roomDiv.onclick = () => joinRoom(room.id);
        roomList.appendChild(roomDiv);
      });
    }

    function joinRoom(roomId) {
      const room = rooms[roomId];
      if (room.players.length >= 2) {
        alert("Комната заполнена!");
        return;
      }

      currentRoom = room;
      const playerName = prompt("Введите свое имя:");
      room.players.push(playerName);
      playerColor = room.players.length === 1 ? "white" : "black";
      updateRooms();
      if (room.players.length === 2) startGame();

      channel.postMessage({ type: "room_update", room });
    }

    function updateRooms() {
      document.querySelectorAll(".room").forEach((roomDiv, index) => {
        const room = rooms[index];
        roomDiv.textContent = `Комната ${room.id + 1} (${room.players.length}/2)`;
        if (room.players.length === 2) {
          roomDiv.classList.add("full");
        } else {
          roomDiv.classList.remove("full");
        }
      });
    }

    function startGame() {
      initializeBoard();
      turn = "white";
      channel.postMessage({ type: "game_start", room: currentRoom });
    }

    function initializeBoard() {
      board.innerHTML = "";
      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          const cell = document.createElement("div");
          cell.classList.add("cell");
          cell.dataset.row = row;
          cell.dataset.col = col;

          if ((row + col) % 2 === 1) {
            if (row < 3) {
              const piece = createPiece("black");
              boardState[row][col] = piece;
              cell.appendChild(piece);
            } else if (row > 4) {
              const piece = createPiece("white");
              boardState[row][col] = piece;
              cell.appendChild(piece);
            }
          }

          board.appendChild(cell);
        }
      }
    }

    function createPiece(color) {
      const piece = document.createElement("div");
      piece.classList.add("piece", color);
      piece.draggable = true;
      piece.addEventListener("dragstart", dragStart);
      return piece;
    }

    let draggedPiece = null;
    let sourceCell = null;

    function dragStart(e) {
      if (turn !== playerColor) return;
      draggedPiece = e.target;
      sourceCell = draggedPiece.parentElement;
      setTimeout(() => (draggedPiece.style.visibility = "hidden"), 0);
    }

    board.addEventListener("dragover", e => e.preventDefault());

    board.addEventListener("drop", e => {
      const targetCell = e.target;
      if (targetCell.classList.contains("cell") && isValidMove(sourceCell, targetCell)) {
        targetCell.appendChild(draggedPiece);
        draggedPiece.style.visibility = "visible";
        updateTurn();

        const newBoardState = Array.from(board.children).map(cell => {
          return cell.children.length ? cell.children[0].className : null;
        });

        currentRoom.boardState = newBoardState;
        channel.postMessage({ type: "board_update", boardState: newBoardState });
      }
    });

    function isValidMove(source, target) {
      const sourceRow = parseInt(source.dataset.row);
      const sourceCol = parseInt(source.dataset.col);
      const targetRow = parseInt(target.dataset.row);
      const targetCol = parseInt(target.dataset.col);
      const direction = playerColor === "white" ? -1 : 1
      const validMove = (targetRow - sourceRow === direction) &&
                        (Math.abs(targetCol - sourceCol) === 1) &&
                        !target.children.length;

      return validMove;
    }

    function updateTurn() {
      turn = turn === "white" ? "black" : "white";
    }

    chatSend.addEventListener("click", () => {
      const message = chatInput.value.trim();
      if (message) {
        currentRoom.chat.push({ player: playerColor, message });
        chatMessages.innerHTML += `<div>${playerColor}: ${message}</div>`;
        chatInput.value = "";
        chatMessages.scrollTop = chatMessages.scrollHeight;

        channel.postMessage({ type: "chat_message", chat: currentRoom.chat });
      }
    });

    channel.onmessage = (e) => {
      const { type, room, boardState: newBoardState, chat } = e.data;

      if (type === "room_update") {
        rooms[room.id] = room;
        updateRooms();
      } else if (type === "game_start") {
        initializeBoard();
      } else if (type === "board_update") {
        boardState = newBoardState;
        updateBoard();
      } else if (type === "chat_message") {
        chatMessages.innerHTML = chat.map(c => `<div>${c.player}: ${c.message}</div>`).join("");
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    };

    function updateBoard() {
      Array.from(board.children).forEach((cell, index) => {
        cell.innerHTML = "";
        const pieceClass = boardState.flat()[index];
        if (pieceClass) {
          const piece = document.createElement("div");
          piece.className = pieceClass;
          piece.draggable = true;
          piece.addEventListener("dragstart", dragStart);
          cell.appendChild(piece);
        }
      });
    }

    initializeRooms();
  </script>
</body>
</html>

