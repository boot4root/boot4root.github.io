<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Шашки (P2P)</title>
  <style>
    /* (Весь CSS остаётся без изменений, используйте ваш оригинальный стиль) */
  </style>
</head>
<body>
  <div class="header">
    <h1>Шашки (P2P)</h1>
    <button id="createGame">Создать игру</button>
    <button id="joinGame">Присоединиться к игре</button>
  </div>
  <div id="signalArea">
    <textarea id="signalData" placeholder="Скопируйте или вставьте данные для подключения"></textarea>
    <button id="sendSignal">Отправить</button>
  </div>
  <div class="game-container">
    <div class="board" id="board"></div>
  </div>

  <script>
    const board = document.getElementById("board");
    const createGameButton = document.getElementById("createGame");
    const joinGameButton = document.getElementById("joinGame");
    const signalArea = document.getElementById("signalArea");
    const signalData = document.getElementById("signalData");
    const sendSignalButton = document.getElementById("sendSignal");

    let peerConnection;
    let dataChannel;

    const config = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    function initializeBoard() {
      board.innerHTML = "";
      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          const cell = document.createElement("div");
          cell.classList.add("cell");
          cell.dataset.row = row;
          cell.dataset.col = col;

          // Добавьте начальное состояние шашек
          if ((row + col) % 2 === 1) {
            if (row < 3) {
              cell.appendChild(createPiece("black"));
            } else if (row > 4) {
              cell.appendChild(createPiece("white"));
            }
          }
          board.appendChild(cell);
        }
      }
    }

    function createPiece(color) {
      const piece = document.createElement("div");
      piece.classList.add("piece", color);
      return piece;
    }

    function setupConnection(isInitiator) {
      peerConnection = new RTCPeerConnection(config);

      if (isInitiator) {
        dataChannel = peerConnection.createDataChannel("game");
        setupDataChannel();
      } else {
        peerConnection.ondatachannel = event => {
          dataChannel = event.channel;
          setupDataChannel();
        };
      }

      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          signalData.value = JSON.stringify(peerConnection.localDescription);
        }
      };

      peerConnection.onconnectionstatechange = () => {
        if (peerConnection.connectionState === "connected") {
          console.log("Соединение установлено!");
        }
      };
    }

    function setupDataChannel() {
      dataChannel.onmessage = event => {
        const message = JSON.parse(event.data);
        handleIncomingData(message);
      };

      dataChannel.onopen = () => console.log("Канал данных открыт!");
    }

    function handleIncomingData(data) {
      if (data.type === "move") {
        const { from, to } = data.payload;
        const sourceCell = document.querySelector(`[data-row="${from.row}"][data-col="${from.col}"]`);
        const targetCell = document.querySelector(`[data-row="${to.row}"][data-col="${to.col}"]`);

        if (sourceCell && targetCell && sourceCell.firstChild) {
          targetCell.appendChild(sourceCell.firstChild);
        }
      }
    }

    createGameButton.addEventListener("click", async () => {
      setupConnection(true);
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      signalArea.style.display = "block";
    });

    joinGameButton.addEventListener("click", async () => {
      setupConnection(false);
      signalArea.style.display = "block";
    });

    sendSignalButton.addEventListener("click", async () => {
      const signal = JSON.parse(signalData.value);

      if (signal.type === "offer") {
        await peerConnection.setRemoteDescription(signal);
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        signalData.value = JSON.stringify(peerConnection.localDescription);
      } else if (signal.type === "answer") {
        await peerConnection.setRemoteDescription(signal);
      }
    });

    board.addEventListener("click", event => {
      const targetCell = event.target.closest(".cell");
      if (!targetCell || !targetCell.firstChild) return;

      const row = targetCell.dataset.row;
      const col = targetCell.dataset.col;

      // Пример передачи данных о ходе
      if (dataChannel && dataChannel.readyState === "open") {
        dataChannel.send(JSON.stringify({ type: "move", payload: { from: { row, col }, to: { row: 2, col: 2 } } }));
      }
    });

    initializeBoard();
  </script>
</body>
</html>
