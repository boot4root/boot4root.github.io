<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Шашки (P2P)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0;
      height: 100vh;
      background-color: #f0f0f0;
    }
    .header {
      margin-bottom: 20px;
    }
    .game-container {
      display: grid;
      grid-template-columns: repeat(8, 50px);
      grid-template-rows: repeat(8, 50px);
      gap: 0;
      border: 2px solid #000;
    }
    .cell {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cell:nth-child(odd) {
      background-color: #8B4513;
    }
    .cell:nth-child(even) {
      background-color: #f0d9b5;
    }
    .piece {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .piece.black {
      background-color: black;
    }
    .piece.white {
      background-color: white;
    }
    #signalArea {
      margin-top: 10px;
      display: none;
    }
    textarea {
      width: 300px;
      height: 100px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Шашки (P2P)</h1>
    <button id="createGame">Создать игру</button>
    <button id="joinGame">Присоединиться к игре</button>
  </div>
  <div id="signalArea">
    <textarea id="signalData" placeholder="Скопируйте или вставьте данные для подключения"></textarea>
    <button id="sendSignal">Отправить</button>
  </div>
  <div class="game-container" id="board"></div>

  <script>
    const board = document.getElementById("board");
    const createGameButton = document.getElementById("createGame");
    const joinGameButton = document.getElementById("joinGame");
    const signalArea = document.getElementById("signalArea");
    const signalData = document.getElementById("signalData");
    const sendSignalButton = document.getElementById("sendSignal");

    let peerConnection;
    let dataChannel;
    let currentTurn = "white"; // Белый всегда ходит первым

    const config = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    function initializeBoard() {
      board.innerHTML = "";
      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          const cell = document.createElement("div");
          cell.classList.add("cell");
          cell.dataset.row = row;
          cell.dataset.col = col;

          if ((row + col) % 2 === 1) {
            if (row < 3) {
              cell.appendChild(createPiece("black"));
            } else if (row > 4) {
              cell.appendChild(createPiece("white"));
            }
          }

          board.appendChild(cell);
        }
      }
    }

    function createPiece(color) {
      const piece = document.createElement("div");
      piece.classList.add("piece", color);
      return piece;
    }

    function setupConnection(isInitiator) {
      peerConnection = new RTCPeerConnection(config);

      if (isInitiator) {
        dataChannel = peerConnection.createDataChannel("game");
        setupDataChannel();
      } else {
        peerConnection.ondatachannel = event => {
          dataChannel = event.channel;
          setupDataChannel();
        };
      }

      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          signalData.value = JSON.stringify(peerConnection.localDescription);
        }
      };

      peerConnection.onconnectionstatechange = () => {
        if (peerConnection.connectionState === "connected") {
          console.log("Соединение установлено!");
        }
      };
    }

    function setupDataChannel() {
      dataChannel.onmessage = event => {
        const message = JSON.parse(event.data);
        handleIncomingData(message);
      };

      dataChannel.onopen = () => console.log("Канал данных открыт!");
    }

    function handleIncomingData(data) {
      if (data.type === "move") {
        const { from, to } = data.payload;
        const sourceCell = document.querySelector(`[data-row="${from.row}"][data-col="${from.col}"]`);
        const targetCell = document.querySelector(`[data-row="${to.row}"][data-col="${to.col}"]`);

        if (sourceCell && targetCell && sourceCell.firstChild) {
          targetCell.appendChild(sourceCell.firstChild);
          currentTurn = currentTurn === "white" ? "black" : "white";
        }
      }
    }

    createGameButton.addEventListener("click", async () => {
      setupConnection(true);
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      signalArea.style.display = "block";
    });

    joinGameButton.addEventListener("click", async () => {
      setupConnection(false);
      signalArea.style.display = "block";
    });

    sendSignalButton.addEventListener("click", async () => {
      const signal = JSON.parse(signalData.value);

      if (signal.type === "offer") {
        await peerConnection.setRemoteDescription(signal);
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        signalData.value = JSON.stringify(peerConnection.localDescription);
      } else if (signal.type === "answer") {
        await peerConnection.setRemoteDescription(signal);
      }
    });

    let selectedCell = null;

    board.addEventListener("click", event => {
      const targetCell = event.target.closest(".cell");
      if (!targetCell) return;

      const row = parseInt(targetCell.dataset.row);
      const col = parseInt(targetCell.dataset.col);

      if (selectedCell && targetCell !== selectedCell) {
        // Проверяем корректность хода
        if (isValidMove(selectedCell, targetCell)) {
          targetCell.appendChild(selectedCell.firstChild);
          sendMove(selectedCell, targetCell);
          currentTurn = currentTurn === "white" ? "black" : "white";
        }
        selectedCell = null;
      } else if (targetCell.firstChild && targetCell.firstChild.classList.contains(currentTurn)) {
        selectedCell = targetCell;
      }
    });

    function isValidMove(fromCell, toCell) {
      const fromRow = parseInt(fromCell.dataset.row);
      const fromCol = parseInt(fromCell.dataset.col);
      const toRow = parseInt(toCell.dataset.row);
      const toCol = parseInt(toCell.dataset.col);

      const rowDiff = Math.abs(fromRow - toRow);
      const colDiff = Math.abs(fromCol - toCol);

      return rowDiff === 1 && colDiff === 1 && !toCell.firstChild;
    }

    function sendMove(fromCell, toCell) {
      if (dataChannel && dataChannel.readyState === "open") {
        const from = { row: parseInt(fromCell.dataset.row), col: parseInt(fromCell.dataset.col) };
        const to = { row: parseInt(toCell.dataset.row), col: parseInt(toCell.dataset.col) };
        dataChannel.send(JSON.stringify({ type: "move", payload: { from, to } }));
      }
    }

    initializeBoard();
  </script>
</body>
</html>
